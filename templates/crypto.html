<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Binance Markets Overview Clone</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0b0b0b;
      color: #f0f0f0;
    }

    .scrollbar-thin::-webkit-scrollbar {
      height: 8px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: #1a1a1a;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #f3ba2f;
      border-radius: 10px;
    }

    img {
    object-fit: contain;
    }

    
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <header class="bg-black border-b border-gray-800">
    <div class="container mx-auto flex items-center justify-between py-4 px-6">
      <div class="flex items-center space-x-4">
        <img src="{{ url_for('static', filename='logo.jpeg') }}"
     class="w-8 h-8 object-contain"
     alt="Logo">
        <h1 class="text-yellow-400 font-bold text-xl">DEFINN</h1>
      </div>
      <nav class="hidden md:flex space-x-6 text-gray-300 font-semibold">
        <a href="#" class="hover:text-yellow-400 transition">Markets</a>
        <a href="#" class="hover:text-yellow-400 transition">Trade</a>
      </nav>
      <div class="hidden md:flex space-x-4 items-center">
        <button id="connectWalletBtn" class="bg-yellow-400 text-black font-semibold px-4 py-1 rounded hover:bg-yellow-500 transition">Connect Wallet</button>
        <span id="walletBalance" class="text-yellow-400 font-semibold">
         Wallet: ₹0.00
        </span>

        
      </div>
      <button class="md:hidden text-yellow-400 focus:outline-none">
        <i class="fas fa-bars fa-lg"></i>
      </button>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-8">
    <section id="markets-page">
      <h2 class="text-3xl font-bold mb-6">Markets Overview</h2>

      <div class="overflow-x-auto scrollbar-thin rounded-lg border border-gray-700">
        <table class="min-w-full text-left text-sm">
          <thead class="bg-gray-900 text-gray-400 uppercase">
            <tr>
              <th class="px-4 py-3">Pair</th>
              <th class="px-4 py-3">Last Price</th>
              <th class="px-4 py-3">24h Change</th>
              <th class="px-4 py-3">24h High</th>
              <th class="px-4 py-3">24h Low</th>
              <th class="px-4 py-3">24h Volume</th>
              <th class="px-4 py-3">Actions</th>
            </tr>
          </thead>
          <tbody id="market-data-body">
            <tr>
              <td colspan="7" class="text-center py-6 text-gray-400">Loading market data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section id="trade-page" class="hidden">
      <h2 class="text-3xl font-bold mb-6">Crypto News</h2>
      <div id="news-container" class="space-y-4 max-h-[600px] overflow-y-auto rounded-lg border border-gray-700 p-4 bg-black">
        <p class="text-gray-400">Loading news...</p>
      </div>
    </section>

    <section class="mt-10">
  <h2 class="text-2xl font-bold mb-4 text-yellow-400">My Crypto Portfolio</h2>

  <div class="overflow-x-auto rounded-lg border border-gray-700">
    <table class="min-w-full text-left text-sm">
      <thead class="bg-gray-900 text-gray-400 uppercase">
        <tr>
          <th class="px-4 py-3">Coin</th>
          <th class="px-4 py-3">Quantity</th>
          <th class="px-4 py-3">Buy Price</th>
          <th class="px-4 py-3">Current Price</th>
          <th class="px-4 py-3">P/L</th>
        </tr>
      </thead>
      <tbody id="portfolioBody">
        <tr>
          <td colspan="5" class="text-center py-6 text-gray-400">
            No holdings yet
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

  </main>

  <footer class="bg-black border-t border-gray-800 py-4 mt-12">
    <div class="container mx-auto text-center text-gray-500 text-sm">
      &copy; 2026 DEFINN 
    </div>
  </footer>

  <script>
    let userAccount = null;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          userAccount = accounts[0];
          document.getElementById('connectWalletBtn').textContent = `Connected: ${userAccount.slice(0,6)}...${userAccount.slice(-4)}`;
          document.getElementById('connectWalletBtn').disabled = true;
        } catch (error) {
          alert('Wallet connection rejected.');
        }
      } else {
        alert('MetaMask is not installed. Please install it to use this feature.');
      }
    }

    async function buyCrypto(symbol, price) {
  if (!userAccount) {
    alert("Please connect your wallet first.");
    return;
  }

  const qty = prompt(`Enter quantity of ${symbol} to buy:`);

  if (!qty || isNaN(qty) || qty <= 0) {
    alert("Invalid quantity");
    return;
  }

  
  const res = await fetch("http://localhost:3000/api/crypto/buy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      symbol,
      quantity: qty,
      price
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.error);
    return;
  }

  
  await window.ethereum.request({
    method: "personal_sign",
    params: [
      `Authorize BUY of ${qty} ${symbol} on DEFINN`,
      userAccount
    ]
  });

  alert("Crypto purchased & wallet updated");
  loadWalletBalance();
  loadCryptoPortfolio();


}


    async function sellCrypto(symbol, price) {
  if (!userAccount) {
    alert("Please connect your wallet first.");
    return;
  }

  const qty = prompt(`Enter quantity of ${symbol} to sell:`);

  if (!qty || isNaN(qty) || qty <= 0) {
    alert("Invalid quantity");
    return;
  }

  const res = await fetch("http://localhost:3000/api/crypto/sell", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      symbol,
      quantity: qty,
      price
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert(data.error);
    return;
  }

  await window.ethereum.request({
    method: "personal_sign",
    params: [
      `Authorize SELL of ${qty} ${symbol} on DEFINN`,
      userAccount
    ]
  });

  alert("Crypto sold & wallet credited");

  loadWalletBalance();
  loadCryptoPortfolio();
}


async function loadWalletBalance() {
  try {
    const res = await fetch("http://localhost:3000/api/wallet");
    const data = await res.json();
    document.getElementById("walletBalance").innerText =
      "Wallet: ₹" + data.balance.toFixed(2);
  } catch (err) {
    console.error("Failed to load wallet balance", err);
  }
}

    async function fetchMarketData() {
      const tbody = document.getElementById('market-data-body');
      try {
        const response = await fetch('https://api.binance.com/api/v3/ticker/24hr');
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        const usdtPairs = data.filter(item => item.symbol.endsWith('USDT'));
        usdtPairs.sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
        const topPairs = usdtPairs.slice(0, 20);

        tbody.innerHTML = '';
        topPairs.forEach(pair => {
          const price = parseFloat(pair.lastPrice).toFixed(6);
          const priceChange = parseFloat(pair.priceChangePercent).toFixed(2);
          const highPrice = parseFloat(pair.highPrice).toFixed(6);
          const lowPrice = parseFloat(pair.lowPrice).toFixed(6);
          const volume = parseFloat(pair.volume).toFixed(2);

          const isPositive = priceChange >= 0;
          const changeClass = isPositive ? 'text-green-500' : 'text-red-500';
          const changeSign = isPositive ? '+' : '';

          const baseAsset = pair.symbol.replace('USDT', '');
          const iconUrl = `https://cryptologos.cc/logos/${baseAsset.toLowerCase()}-${baseAsset.toLowerCase()}-logo.svg?v=023`;

          const row = document.createElement('tr');
          row.className = 'border-b border-gray-800 hover:bg-gray-800 transition';
          row.innerHTML = `
            <td class="px-4 py-3 flex items-center space-x-2">
              <img src="${iconUrl}" alt="${baseAsset}" class="h-6 w-6" onerror="this.style.display='none'" />
              <span>${pair.symbol.slice(0, -4)}/USDT</span>
            </td>
            <td class="px-4 py-3">$${price}</td>
            <td class="px-4 py-3 ${changeClass}">${changeSign}${priceChange}%</td>
            <td class="px-4 py-3">$${highPrice}</td>
            <td class="px-4 py-3">$${lowPrice}</td>
            <td class="px-4 py-3">${volume} ${baseAsset}</td>
            <td class="px-4 py-3 space-x-2">
              <button onclick="buyCrypto('${pair.symbol}', ${pair.lastPrice})"
               class="bg-green-600 hover:bg-green-700 text-white font-semibold px-3 py-1 rounded transition">
               Buy
              </button>

              <button onclick="sellCrypto('${pair.symbol}', ${pair.lastPrice})"
                class="bg-red-600 hover:bg-red-700 text-white font-semibold px-3 py-1 rounded transition">
                Sell
              </button>

            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-6 text-red-500">Failed to load market data.</td></tr>`;
        console.error('Error fetching market data:', error);
      }
    }

    document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);

    const marketsPage = document.getElementById('markets-page');
    const tradePage = document.getElementById('trade-page');
    const navLinks = document.querySelectorAll('nav a');

    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const text = link.textContent.trim();

        if (text === 'Markets') {
          marketsPage.classList.remove('hidden');
          tradePage.classList.add('hidden');
        } else if (text === 'Trade') {
          marketsPage.classList.add('hidden');
          tradePage.classList.remove('hidden');
          fetchCryptoNews();
        }
      });
    });

async function loadCryptoPortfolio() {
  const tbody = document.getElementById("portfolioBody");

  try {
    const res = await fetch("http://localhost:3000/api/crypto/holdings");
    const holdings = await res.json();

    if (holdings.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-6 text-gray-400">
            No holdings yet
          </td>
        </tr>`;
      return;
    }

    tbody.innerHTML = "";

    for (const h of holdings) {
      const priceRes = await fetch(
        `https://api.binance.com/api/v3/ticker/price?symbol=${h.symbol}`
      );
      const priceData = await priceRes.json();

      const currentPrice = parseFloat(priceData.price);
      const invested = h.quantity * h.buy_price;
      const currentValue = h.quantity * currentPrice;
      const pnl = currentValue - invested;

      const pnlClass = pnl >= 0 ? "text-green-500" : "text-red-500";

      const row = document.createElement("tr");
      row.className = "border-b border-gray-800";
      row.innerHTML = `
        <td class="px-4 py-3">${h.symbol.replace("USDT", "")}</td>
        <td class="px-4 py-3">${h.quantity}</td>
        <td class="px-4 py-3">₹${h.buy_price.toFixed(2)}</td>
        <td class="px-4 py-3">₹${currentPrice.toFixed(2)}</td>
        <td class="px-4 py-3 ${pnlClass}">
          ₹${pnl.toFixed(2)}
        </td>
      `;

      tbody.appendChild(row);
    }
  } catch (err) {
    console.error("Failed to load portfolio", err);
  }
}


    fetchMarketData();
    setInterval(fetchMarketData, 3000);
    loadWalletBalance();
    loadCryptoPortfolio();



     const cryptoNewsApiKey = 'pub_84295477a80254ff20c10a6efef160f61e22e';

    async function fetchCryptoNews() {
      const newsContainer = document.getElementById('news-container');
      newsContainer.innerHTML = '<p class="text-gray-400">Loading news...</p>';
      try {
        const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://www.coindesk.com/arc/outboundfeeds/rss/'));
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const data = await response.json();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(data.contents, "text/xml");
        const items = xmlDoc.querySelectorAll("item");
        if (items.length === 0) {
          newsContainer.innerHTML = '<p class="text-gray-400">No news available.</p>';
          return;
        }
        newsContainer.innerHTML = '';
        items.forEach(item => {
          const title = item.querySelector("title")?.textContent || "No title";
          const link = item.querySelector("link")?.textContent || "#";
          const pubDate = item.querySelector("pubDate")?.textContent || "";
          const date = pubDate ? new Date(pubDate).toLocaleString() : "";
          const newsEl = document.createElement('div');
          newsEl.className = 'p-4 border border-gray-700 rounded hover:bg-gray-800 transition cursor-pointer';
          newsEl.innerHTML = `
            <a href="${link}" target="_blank" rel="noopener noreferrer" class="text-yellow-400 font-semibold text-lg hover:underline">${title}</a>
            <p class="text-gray-400 text-sm mt-1">${date}</p>
          `;
          newsContainer.appendChild(newsEl);
        });
      } catch (error) {
        newsContainer.innerHTML = `<p class="text-red-500">Failed to load news.</p>`;
        console.error('Error fetching crypto news:', error);
      }
    }
  </script>

</body>
</html>
