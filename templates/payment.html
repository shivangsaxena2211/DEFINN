<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment Interface</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-content { transition: all 0.3s ease-in-out; }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div class="max-w-4xl w-full bg-white rounded-lg shadow-lg p-6">

    <header class="mb-8">
      <img src="{{ url_for('static', filename='logo.jpeg') }}"
     class="w-8 h-8 object-contain"
     alt="Logo">
      <h1 class="text-3xl font-semibold text-gray-800 mb-2">Payment Dashboard</h1>

      <div class="flex flex-wrap justify-between items-center gap-4">

        <div class="flex items-center space-x-3">
          <i class="fas fa-id-badge text-indigo-600 text-2xl"></i>
          <div>
            <p class="text-gray-600 text-sm">Logged in as</p>

            <p class="text-lg font-medium text-gray-900 select-all"
   id="userDisplayName"
   title="Click to copy"
   onclick="copyToClipboard('userDisplayName')">
  Loading...
</p>

<p id="actualUserId" class="hidden">Loading...</p>

          </div>
        </div>

        <div class="flex items-center space-x-3">
          <i class="fas fa-wallet text-green-600 text-2xl"></i>
          <div>
            <p class="text-gray-600 text-sm">Wallet Balance</p>
            <p class="text-lg font-semibold text-gray-900" id="walletAmount">₹0.00</p>
          </div>
        </div>

      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-2 gap-8">

      <section class="bg-indigo-50 rounded-lg p-5 shadow-sm">
        <h2 class="text-xl font-semibold text-indigo-700 mb-4">Send Money</h2>

        <div class="flex space-x-4 mb-4">
          <button class="send-mode-btn bg-indigo-600 text-white px-4 py-2 rounded-md flex items-center space-x-2 focus:outline-none focus:ring-2 focus:ring-indigo-400" data-mode="qr">
            <i class="fas fa-qrcode"></i><span>Scan QR</span>
          </button>
          <button class="send-mode-btn bg-indigo-100 text-indigo-700 px-4 py-2 rounded-md flex items-center space-x-2 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-400" data-mode="contacts">
            <i class="fas fa-address-book"></i><span>Contacts</span>
          </button>
          <button class="send-mode-btn bg-indigo-100 text-indigo-700 px-4 py-2 rounded-md flex items-center space-x-2 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-400" data-mode="paymentId">
            <i class="fas fa-id-badge"></i><span>Payment ID</span>
          </button>
        </div>

        <div id="sendModeContent" class="tab-content">

          <div class="send-mode-panel" data-panel="qr">
            <p class="text-gray-700 mb-3">Scan the recipient's QR code to send money.</p>
            <div id="qr-reader" class="w-48 h-48 mx-auto rounded-md border border-gray-300 bg-white"></div>
            <button id="start-scan-btn" class="mt-2 w-1/2 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition">Start Camera</button>
            <button id="stop-scan-btn" class="mt-2 ml-2 w-1/2 bg-red-600 text-white py-2 rounded-md hover:bg-red-700 transition">Stop Camera</button>
            <p id="qr-result" class="mt-2 text-center text-indigo-700 font-semibold"></p>
          </div>

          <div class="send-mode-panel hidden" data-panel="contacts">
            <p class="text-gray-700 mb-3">Select a contact to send money.</p>
            <select id="send-contact-select" class="w-full p-2 border border-gray-300 rounded-md" aria-label="Select contact to send money">
              <option value="" disabled selected>Select contact</option>
              <option value="Alice Johnson">Alice Johnson</option>
              <option value="Bob Smith">Bob Smith</option>
              <option value="Charlie Davis">Charlie Davis</option>
            </select>
            <input id="send-contact-amount" type="number" min="0" step="0.01" placeholder="Amount" class="mt-3 w-full p-2 border border-gray-300 rounded-md" aria-label="Amount to send" />
            <button id="send-contact-btn" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition">Send</button>
          </div>

          <div class="send-mode-panel hidden" data-panel="paymentId">
            <p class="text-gray-700 mb-3">Enter recipient's Payment ID to send money.</p>
            <input id="send-paymentid-input" type="text" placeholder="Recipient Payment ID" class="w-full p-2 border border-gray-300 rounded-md" aria-label="Recipient Payment ID" />
            <input id="send-paymentid-amount" type="number" min="0" step="0.01" placeholder="Amount" class="mt-3 w-full p-2 border border-gray-300 rounded-md" aria-label="Amount to send" />
            <button id="send-paymentid-btn" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition">Send</button>
          </div>

        </div>
      </section>

      <section class="bg-green-50 rounded-lg p-5 shadow-sm">
        <h2 class="text-xl font-semibold text-green-700 mb-4">Receive Money</h2>

        <div class="flex space-x-4 mb-4">
          <button class="receive-mode-btn bg-green-600 text-white px-4 py-2 rounded-md flex items-center space-x-2 focus:outline-none focus:ring-2 focus:ring-green-400" data-mode="qr">
            <i class="fas fa-qrcode"></i><span>QR Code</span>
          </button>
          <button class="receive-mode-btn bg-green-100 text-green-700 px-4 py-2 rounded-md flex items-center space-x-2 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-green-400" data-mode="contacts">
            <i class="fas fa-address-book"></i><span>Contacts</span>
          </button>
          <button class="receive-mode-btn bg-green-100 text-green-700 px-4 py-2 rounded-md flex items-center space-x-2 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-green-400" data-mode="paymentId">
            <i class="fas fa-id-badge"></i><span>Payment ID</span>
          </button>
        </div>

        <div id="receiveModeContent" class="tab-content">

          <div class="receive-mode-panel" data-panel="qr">
            <p class="text-gray-700 mb-3">Show your QR code to receive money.</p>
            <div id="user-qr-code" class="w-48 h-48 bg-white border border-gray-300 rounded-md flex items-center justify-center mx-auto"></div>
          </div>

          <div class="receive-mode-panel hidden" data-panel="contacts">
            <p class="text-gray-700 mb-3">Select a contact to request money from.</p>
            <select class="w-full p-2 border border-gray-300 rounded-md" aria-label="Select contact to request money">
              <option value="" disabled selected>Select contact</option>
              <option value="contact1">Alice Johnson</option>
              <option value="contact2">Bob Smith</option>
              <option value="contact3">Charlie Davis</option>
            </select>
            <input type="number" min="0" step="0.01" placeholder="Amount" class="mt-3 w-full p-2 border border-gray-300 rounded-md" aria-label="Amount to request" />
            <button class="mt-4 w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition">Request</button>
          </div>

          <div class="receive-mode-panel hidden" data-panel="paymentId">
            <p class="text-gray-700 mb-3">Share your Payment ID to receive money.</p>

            <p id="receivePaymentId"
               class="font-mono bg-white p-3 rounded-md border border-gray-300 select-all cursor-pointer"
               title="Click to copy"
               onclick="copyToClipboard('receivePaymentId')">
              Loading...
            </p>
          </div>

        </div>
      </section>

    </main>

    <section class="mt-10 bg-white rounded-lg shadow p-6 max-w-4xl mx-auto">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History</h2>

      <div class="overflow-y-auto max-h-64 border border-gray-200 rounded-md">
        <table class="w-full text-left text-gray-700">
          <thead class="bg-gray-100 sticky top-0">
            <tr>
              <th class="py-2 px-4">Date</th>
              <th class="py-2 px-4">Type</th>
              <th class="py-2 px-4">Amount</th>
              <th class="py-2 px-4">From</th>
              <th class="py-2 px-4">To</th>
            </tr>
          </thead>

          <tbody id="transactionHistory"></tbody>
        </table>
      </div>
    </section>

  </div>

  <script>
    const BASE_URL = "http://localhost:3000";

    
    async function loadCurrentUser() {
  try {
    const res = await fetch(`${BASE_URL}/api/me`, {
      method: "GET",
      credentials: "include",
    });

    const data = await res.json();

    if (!data.logged_in) {
      window.location.href = `${BASE_URL}/login`;
      return;
    }

    document.getElementById("userDisplayName").textContent = data.user_id;
    document.getElementById("actualUserId").textContent = data.user_id;
    document.getElementById("receivePaymentId").textContent = data.user_id;

    try {
      const pres = await fetch(`${BASE_URL}/api/profile`, {
        method: "GET",
        credentials: "include",
      });

      if (pres.ok) {
        const pdata = await pres.json();

        document.getElementById("userDisplayName").textContent =
          pdata.name || data.user_id;

        document.getElementById("actualUserId").textContent =
          pdata.user_id || data.user_id;

        document.getElementById("receivePaymentId").textContent =
          pdata.user_id || data.user_id;

        generateUserQr(pdata.user_id || data.user_id);
      } else {
        generateUserQr(data.user_id);
      }
    } catch {
      generateUserQr(data.user_id);
    }

  } catch (err) {
    alert("Backend not reachable. Start Flask backend on port 3000.");
  }
}


    
    
    function generateUserQr(paymentId) {
      const qrCodeContainer = document.getElementById("user-qr-code");
      if (!qrCodeContainer) return;

      if (!window.QRCode) {
        const script = document.createElement("script");
        script.src = "https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js";
        script.onload = () => generateUserQr(paymentId);
        document.body.appendChild(script);
        return;
      }

      QRCode.toCanvas(paymentId, { width: 192, margin: 1 }, (error, canvas) => {
        if (error) {
          qrCodeContainer.innerHTML = '<p class="text-red-600">Failed to generate QR code.</p>';
          return;
        }
        qrCodeContainer.innerHTML = "";
        qrCodeContainer.appendChild(canvas);
      });
    }

  
    async function loadWalletBalance() {
      const res = await fetch(`${BASE_URL}/api/wallet`, {
        method: "GET",
        credentials: "include",
      });

      if (res.status === 401) {
        window.location.href = `${BASE_URL}/login`;
        return;
      }

      const data = await res.json();
      document.getElementById("walletAmount").innerText = "₹" + Number(data.balance || 0).toFixed(2);
    }

    
    async function loadTransactionHistory() {
      const response = await fetch(`${BASE_URL}/api/transactions`, {
        method: "GET",
        credentials: "include",
      });

      if (response.status === 401) {
        window.location.href = `${BASE_URL}/login`;
        return;
      }

      const transactions = await response.json();
      const tbody = document.getElementById("transactionHistory");
      tbody.innerHTML = "";

      if (!Array.isArray(transactions) || transactions.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="py-3 px-4 text-center text-gray-500">No transactions yet.</td>
          </tr>
        `;
        return;
      }

      transactions.forEach(tx => {
        const date = tx.date ? new Date(tx.date).toISOString().split("T")[0] : "-";
        const type = tx.type || "-";

        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-200 hover:bg-gray-50";

        tr.innerHTML = `
          <td class="py-2 px-4">${date}</td>
          <td class="py-2 px-4 ${type.toLowerCase().includes("received") ? "text-green-600" : "text-red-600"} font-semibold">${type}</td>
          <td class="py-2 px-4">₹${Number(tx.amount || 0).toFixed(2)}</td>
          <td class="py-2 px-4">${tx.from_user || "-"}</td>
          <td class="py-2 px-4">${tx.to_user || "-"}</td>
        `;

        tbody.appendChild(tr);
      });
    }

    const sendContactBtn = document.getElementById("send-contact-btn");
    sendContactBtn.addEventListener("click", async () => {
      const to = document.getElementById("send-contact-select").value;
      const amount = parseFloat(document.getElementById("send-contact-amount").value);
      const from = document.getElementById("actualUserId").textContent.trim();

      if (!to || !amount || amount <= 0) {
        alert("Please select a contact and enter a valid amount.");
        return;
      }

      const response = await fetch(`${BASE_URL}/api/send`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from, to, amount }),
      });

      const data = await response.json();
      if (!response.ok) {
        alert(data.error || "Failed to send money.");
        return;
      }

      alert(data.message);
      loadWalletBalance();
      loadTransactionHistory();
    });

    const sendPaymentIdBtn = document.getElementById("send-paymentid-btn");
    sendPaymentIdBtn.addEventListener("click", async () => {
      const to = document.getElementById("send-paymentid-input").value.trim();
      const amount = parseFloat(document.getElementById("send-paymentid-amount").value);
      const from = document.getElementById("actualUserId").textContent.trim();

      if (!to || !amount || amount <= 0) {
        alert("Please enter a valid Payment ID and amount.");
        return;
      }

      const response = await fetch(`${BASE_URL}/api/send`, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from, to, amount }),
      });

      const data = await response.json();
      if (!response.ok) {
        alert(data.error || "Failed to send money.");
        return;
      }

      alert(data.message);
      loadWalletBalance();
      loadTransactionHistory();
    });

    
    const sendButtons = document.querySelectorAll(".send-mode-btn");
    const sendPanels = document.querySelectorAll(".send-mode-panel");

    sendButtons.forEach(button => {
      button.addEventListener("click", () => {
        sendButtons.forEach(btn => {
          btn.classList.remove("bg-indigo-600", "text-white");
          btn.classList.add("bg-indigo-100", "text-indigo-700");
        });

        button.classList.add("bg-indigo-600", "text-white");
        button.classList.remove("bg-indigo-100", "text-indigo-700");

        const mode = button.getAttribute("data-mode");
        sendPanels.forEach(panel => {
          panel.classList.toggle("hidden", panel.getAttribute("data-panel") !== mode);
        });
      });
    });

    const receiveButtons = document.querySelectorAll(".receive-mode-btn");
    const receivePanels = document.querySelectorAll(".receive-mode-panel");

    receiveButtons.forEach(button => {
      button.addEventListener("click", () => {
        receiveButtons.forEach(btn => {
          btn.classList.remove("bg-green-600", "text-white");
          btn.classList.add("bg-green-100", "text-green-700");
        });

        button.classList.add("bg-green-600", "text-white");
        button.classList.remove("bg-green-100", "text-green-700");

        const mode = button.getAttribute("data-mode");
        receivePanels.forEach(panel => {
          panel.classList.toggle("hidden", panel.getAttribute("data-panel") !== mode);
        });
      });
    });

    
    let html5QrcodeScanner;

    function onScanSuccess(decodedText) {
      document.getElementById("qr-result").textContent = `Scanned Payment ID: ${decodedText}`;
      html5QrcodeScanner.stop();
    }

    function onScanFailure(error) {}

    window.addEventListener("load", () => {
      loadCurrentUser();
      loadWalletBalance();
      loadTransactionHistory();

      html5QrcodeScanner = new Html5Qrcode("qr-reader");
      const config = { fps: 10, qrbox: 250 };

      document.getElementById("start-scan-btn").addEventListener("click", () => {
        html5QrcodeScanner.start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          onScanFailure
        ).catch(() => {
          document.getElementById("qr-result").textContent = "Camera denied or unavailable.";
        });
      });

      document.getElementById("stop-scan-btn").addEventListener("click", () => {
        html5QrcodeScanner.stop().then(() => {
          document.getElementById("qr-result").textContent = "Camera stopped.";
        }).catch(err => {
          document.getElementById("qr-result").textContent = "Error stopping camera: " + err;
        });
      });
    });
  </script>
</body>
</html>
